name: build-gfortran-darwin
    
on:
  workflow_dispatch:
  push:
    tags: [ 'gcc-*' ]

jobs:
  build:
    strategy:
      matrix:
        build_arch:  [x86_64, arm64]        # host CPU
        target_arch: [x86_64, arm64]        # toolchain target
        gcc:         [14.2.0]
    runs-on: ${{ matrix.build_arch == 'arm64' && 'macos-14' || 'macos-13' }}    

    steps:
    - uses: actions/checkout@v4

    - name: Install micromamba
      uses: mamba-org/setup-micromamba@v1
      with:
        init-shell: bash
        cache-downloads: true
        cache-env: true

    - name: Download static prerequisites
      run: |
        mkdir -p downloads
        curl -I -Lso downloads/gmp-6.3.0.tar.gz https://gmplib.org/download/gmp/gmp-6.3.0.tar.gz
        curl -I -Lso downloads/mpfr-4.2.1.tar.gz https://www.mpfr.org/mpfr-4.2.1/mpfr-4.2.1.tar.gz
        curl -I -Lso downloads/mpc-1.3.1.tar.gz https://ftp.gnu.org/gnu/mpc/mpc-1.3.1.tar.gz
        curl -I -Lso downloads/isl-0.26.tar.gz https://libisl.sourceforge.io/isl-0.26.tar.gz
        curl -I -Lso downloads/zlib-1.3.1.tar.gz https://zlib.net/zlib-1.3.1.tar.gz
        
    # (2) single call – the matrix already supplies both arches
    - name: Build compiler
      run: >
        bash scripts/build_gfortran_static.sh
        "${{ matrix.gcc }}"
        "${{ matrix.target_arch }}"
        "${{ matrix.build_arch }}"

    # (2 b) compute a checksum that travels with the tarball ──────────────
    - name: Compute SHA-256
      id: sha256
      run: |
        TARBALL=$(ls gfortran-darwin-${{ matrix.target_arch }}-*.tar.gz)
        shasum -a 256 "$TARBALL" > \
          "gfortran-${{ matrix.target_arch }}-${{ matrix.build_arch }}-${{ matrix.gcc }}.sha256"   

    # (3) upload whatever tarballs were produced in this job ────────────────
    - name: Upload artefacts
      uses: actions/upload-artifact@v4
      with:
        name: gfortran-${{ matrix.target_arch }}-${{ matrix.build_arch }}-${{ matrix.gcc }}
        path: |
          gfortran-darwin-${{ matrix.target_arch }}-*.tar.gz
          gfortran-${{ matrix.target_arch }}-${{ matrix.build_arch }}-${{ matrix.gcc }}.sha256

        
